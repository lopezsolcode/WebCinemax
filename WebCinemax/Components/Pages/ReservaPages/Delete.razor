@page "/reservas/delete/{IdReserva:int}"
@using WebCinemax.Models
@using WebCinemax.Services
@inject ReservaService ReservaService
@inject NavigationManager NavigationManager

<PageTitle>Eliminar Reserva</PageTitle>

<h3 class="text-danger">Eliminar Reserva</h3>

@if (reserva == null)
{
    <p><em>Cargando...</em></p>
}
else
{
    <div class="alert alert-warning">
        <strong>¿Está seguro de que desea eliminar esta reserva?</strong><br />
        Esta acción no se puede deshacer.
    </div>

    <dl class="row">
        <dt class="col-sm-3">ID de Reserva</dt>
        <dd class="col-sm-9">@reserva.IdReserva</dd>

        <dt class="col-sm-3">Fecha de Reserva</dt>
        <dd class="col-sm-9">@reserva.FechaReserva.ToString("g")</dd>

        <dt class="col-sm-3">Confirmada</dt>
        <dd class="col-sm-9">@((reserva.Confirmada) ? "Sí" : "No")</dd>

        <dt class="col-sm-3">Película</dt>
        <dd class="col-sm-9">@reserva.IdFuncionNavigation?.IdPeliculaNavigation?.Titulo</dd>

        <dt class="col-sm-3">Sala</dt>
        <dd class="col-sm-9">@reserva.IdFuncionNavigation?.IdSalaNavigation?.Nombre</dd>
    </dl>

    <div class="mt-3">
        <button class="btn btn-danger" @onclick="EliminarReserva">Eliminar</button>
        <button class="btn btn-secondary ms-2" @onclick="@VolverALista">Cancelar</button>
    </div>

    @if (!string.IsNullOrEmpty(mensaje))
    {
        <div class="alert alert-info mt-3">@mensaje</div>
    }
}

@code {
    private Reserva? reserva;
    private string? mensaje;

    [Parameter]
    public int IdReserva { get; set; }

    protected override async Task OnInitializedAsync()
    {
        reserva = await ReservaService.GetByIdAsync(IdReserva);
        if (reserva == null)
        {
            NavigationManager.NavigateTo("/notfound");
        }
    }

    private async Task EliminarReserva()
    {
        if (reserva != null)
        {
            var exito = await ReservaService.DeleteAsync(reserva.IdReserva);
            if (exito)
            {
                mensaje = "La reserva fue eliminada correctamente.";
                await Task.Delay(1500);
                NavigationManager.NavigateTo("/reservas");
            }
            else
            {
                mensaje = "Ocurrió un error al intentar eliminar la reserva.";
            }
        }
    }

    private void VolverALista()
    {
        NavigationManager.NavigateTo("/reservas");
    }
}