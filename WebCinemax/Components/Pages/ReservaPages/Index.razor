@page "/reservas"
@using WebCinemax.Models
@using Services
@inject NavigationManager NavigationManager
@inject ReservaService ReservaService

<h1>Reservas</h1>

<p>
    <button class="btn btn-primary" @onclick="CrearNueva">Crear nueva</button>
</p>

@if (reservas == null)
{
    <p><em>Cargando...</em></p>
}
else if (!reservas.Any())
{
    <p>No hay reservas registradas.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID Reserva</th> <!-- ✅ Nueva columna -->
                <th>Fecha de Reserva</th>
                <th>Confirmada</th>
                <th>Película</th>
                <th>Sala</th>
                <th>Butacas</th> <!-- ✅ Nueva columna -->
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var r in reservas)
            {
                <tr>
                    <td>@r.IdReserva</td> <!-- ✅ Muestra el número de ID -->
                    <td>@r.FechaReserva.ToString("g")</td>
                    <td>@(r.Confirmada ? "Sí" : "No")</td>
                    <td>@r.IdFuncionNavigation?.IdPeliculaNavigation?.Titulo</td>
                    <td>@r.IdFuncionNavigation?.IdSalaNavigation?.Nombre</td>

                    <!-- ✅ Muestra las butacas reservadas -->
                    <td>
                        @if (r.ReservaButacas != null && r.ReservaButacas.Any())
                        {
                            @string.Join(", ", r.ReservaButacas.Select(b => $"F{b.IdButacaNavigation?.Fila}-N{b.IdButacaNavigation?.Numero}"))
                        }
                        else
                        {
                            <em>Sin butacas</em>
                        }
                    </td>

                    <td>
                        <button class="btn btn-secondary btn-sm" @onclick="() => Editar(r.IdReserva)">Editar</button>
                        <button class="btn btn-danger btn-sm" @onclick="() => EliminarConfirmado(r.IdReserva)">Eliminar</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Reserva>? reservas;

    protected override async Task OnInitializedAsync()
    {
        reservas = await ReservaService.GetAllAsync();
    }

    private void CrearNueva()
    {
        NavigationManager.NavigateTo("/reservas/create");
    }

    private void Editar(int idReserva)
    {
        NavigationManager.NavigateTo($"/reservas/edit/{idReserva}");
    }

    private void EliminarConfirmado(int idReserva)
    {
        NavigationManager.NavigateTo($"/reservas/delete/{idReserva}");
    }
}