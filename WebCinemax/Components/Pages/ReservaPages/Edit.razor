@page "/reservas/edit/{id:int}"
@using WebCinemax.Models
@inject ReservaService ReservaService
@inject NavigationManager NavigationManager

<h3>Editar reserva</h3>

@if (reserva == null || funciones == null)
{
    <p><em>Cargando...</em></p>
}
else
{
    <EditForm Model="@reserva" OnValidSubmit="@GuardarCambios">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Selección de función -->
        <div class="form-group">
            <label>Función</label>
            <select class="form-control" @bind="IdFuncionSeleccionada">
                <option value="">Seleccione una función</option>
                @foreach (var funcion in funciones)
                {
                    <option value="@funcion.IdFuncion">
                        @($"{funcion.IdPeliculaNavigation?.Titulo} - {funcion.FechaHora:g}")
                    </option>
                }
            </select>
        </div>

        <!-- Selección de butacas (múltiple) -->
        <div class="form-group mt-3">
            <label>Butacas disponibles</label>
            <select multiple class="form-control" @onchange="OnButacasChanged">
                @foreach (var b in butacasDisponibles)
                {
                    <option value="@b.IdButaca" selected="@butacasSeleccionadas.Contains(b.IdButaca)">
                        @($"Fila {b.Fila}, N° {b.Numero}")
                    </option>
                }
            </select>
            <small class="text-muted">Mantenga presionada Ctrl para seleccionar múltiples butacas.</small>
        </div>

        <!-- Confirmada -->
        <div class="form-group mt-3">
            <label>Confirmada</label>
            <InputCheckbox @bind-Value="reserva.Confirmada" class="form-check-input" />
        </div>

        <button type="submit" class="btn btn-primary mt-3">Guardar cambios</button>
        <button type="button" class="btn btn-secondary mt-3" @onclick="Volver">Cancelar</button>
    </EditForm>
}

@code {
    [Parameter] public int id { get; set; }

    private Reserva? reserva;
    private List<Funcion> funciones = new();
    private List<Butaca> butacasDisponibles = new();
    private List<int> butacasSeleccionadas = new();
    private int idFuncionSeleccionada;

    private int IdFuncionSeleccionada
    {
        get => idFuncionSeleccionada;
        set
        {
            if (idFuncionSeleccionada != value)
            {
                idFuncionSeleccionada = value;
                _ = CargarButacasDisponibles();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        funciones = await ReservaService.ObtenerFuncionesAsync();

        reserva = await ReservaService.GetByIdAsync(id);
        if (reserva == null)
        {
            NavigationManager.NavigateTo("/reservas");
            return;
        }

        // Establecer función actual
        IdFuncionSeleccionada = reserva.IdFuncion;

        // Cargar butacas disponibles y marcar las seleccionadas
        await CargarButacasDisponibles();

        if (reserva.ReservaButacas != null)
        {
            butacasSeleccionadas = reserva.ReservaButacas
                .Select(rb => rb.IdButaca)
                .ToList();
        }
    }

    private async Task CargarButacasDisponibles()
    {
        if (IdFuncionSeleccionada == 0)
        {
            butacasDisponibles.Clear();
            return;
        }

        butacasDisponibles = await ReservaService.ObtenerButacasDisponiblesPorFuncionAsync(IdFuncionSeleccionada);
        StateHasChanged();
    }

    private void OnButacasChanged(ChangeEventArgs e)
    {
        var selected = e.Value as string[] ?? Array.Empty<string>();
        butacasSeleccionadas = selected.Select(int.Parse).ToList();
    }

    private async Task GuardarCambios()
    {
        if (IdFuncionSeleccionada == 0 || !butacasSeleccionadas.Any())
            return;

        reserva!.IdFuncion = IdFuncionSeleccionada;
        await ReservaService.UpdateReservaAsync(reserva, butacasSeleccionadas);
        NavigationManager.NavigateTo("/reservas");
    }

    private void Volver() => NavigationManager.NavigateTo("/reservas");
}