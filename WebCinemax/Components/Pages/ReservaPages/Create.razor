@page "/reservas/create"
@using WebCinemax.Models
@inject ReservaService ReservaService
@inject NavigationManager NavigationManager

<h3>Crear nueva reserva</h3>

@if (nuevaReserva == null || funciones == null)
{
    <p><em>Cargando...</em></p>
}
else
{
    <EditForm Model="@nuevaReserva" OnValidSubmit="@GuardarReserva">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Selección de función -->
        <div class="form-group">
            <label>Función</label>
            <select class="form-control" @bind="idFuncionSeleccionada">
                <option value="">Seleccione una función</option>
                @foreach (var funcion in funciones)
                {
                    <option value="@funcion.IdFuncion">
                        @($"{funcion.IdPeliculaNavigation?.Titulo} - {funcion.FechaHora:g}")
                    </option>
                }
            </select>
        </div>

        <!-- Selección de butacas (múltiple) -->
        <div class="form-group mt-3">
            <label>Butacas disponibles</label>
            <select multiple class="form-control" @onchange="OnButacasChanged">
                @foreach (var b in butacasDisponibles)
                {
                    <option value="@b.IdButaca">@($"Fila {b.Fila}, N° {b.Numero}")</option>
                }
            </select>
            <small class="text-muted">Mantenga presionada Ctrl para seleccionar múltiples butacas.</small>
        </div>

        <!-- Confirmada -->
        <div class="form-group mt-3">
            <label>Confirmada</label>
            <InputCheckbox @bind-Value="nuevaReserva.Confirmada" class="form-check-input" />
        </div>

        <button type="submit" class="btn btn-primary mt-3">Guardar</button>
        <button type="button" class="btn btn-secondary mt-3" @onclick="Volver">Cancelar</button>
    </EditForm>
}

@code {
    private Reserva nuevaReserva = new();
    private List<Funcion> funciones = new();
    private List<Butaca> butacasDisponibles = new();
    private List<int> butacasSeleccionadas = new();
    private int idFuncionSeleccionada;

    private int IdFuncionSeleccionada
    {
        get => idFuncionSeleccionada;
        set
        {
            if (idFuncionSeleccionada != value)
            {
                idFuncionSeleccionada = value;
                _ = CargarButacasDisponibles(); // carga butacas al cambiar la función
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        funciones = await ReservaService.ObtenerFuncionesAsync();
    }

    private async Task CargarButacasDisponibles()
    {
        if (idFuncionSeleccionada == 0)
        {
            butacasDisponibles.Clear();
            butacasSeleccionadas.Clear();
            return;
        }

        butacasDisponibles = await ReservaService.ObtenerButacasDisponiblesPorFuncionAsync(idFuncionSeleccionada);
        butacasSeleccionadas.Clear(); // limpiar selección anterior
        StateHasChanged();
    }

    // Conversión manual para select múltiple
    private void OnButacasChanged(ChangeEventArgs e)
    {
        var selected = e.Value as string[] ?? Array.Empty<string>();
        butacasSeleccionadas = selected.Select(int.Parse).ToList();
    }

    private async Task GuardarReserva()
    {
        if (idFuncionSeleccionada == 0 || !butacasSeleccionadas.Any())
            return;

        nuevaReserva.IdFuncion = idFuncionSeleccionada;
        await ReservaService.CreateReservaAsync(nuevaReserva, butacasSeleccionadas);
        NavigationManager.NavigateTo("/reservas");
    }

    private void Volver() => NavigationManager.NavigateTo("/reservas");
}